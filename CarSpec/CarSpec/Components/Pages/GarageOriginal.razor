@page "/garageoriginal"
@using CarSpec.Models
@using CarSpec.Constants
@using Microsoft.AspNetCore.Components.Forms
@inject CarSpec.Interfaces.IAppStorage Storage
@inject CarSpec.Interfaces.IVehicleProfileService Profiles
@inject NavigationManager Nav

<h2 class="cs-title">My Garage</h2>

@if (Profiles.Current is VehicleProfile cur && !string.IsNullOrWhiteSpace(cur.Model))
{
    <p>Active Vehicle: <strong>@cur.Year @cur.Make @cur.Model</strong></p>
}
else
{
    <div class="cs-card warn" style="margin-bottom:12px">
        No active vehicle selected. <a href="/garage">Choose one</a> or <a href="/setup">add a car</a>.
    </div>
}

@if (_cars is null)
{
    <p>Loading…</p>
}
else if (_cars.Count == 0)
{
    <div class="cs-card warn">No cars yet. <a href="/setup">Add one</a>.</div>
}
else
{
    <div style="margin:12px 0">
        <button class="cs-btn primary" @onclick="AddNew">➕ Add another car</button>
    </div>

    <div class="cs-grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
        @foreach (var c in _cars)
        {
            <section class="cs-card">
                <h3>@c.Year @c.Make @c.Model</h3>

                @if (IsEditing(c))
                {
                    <!-- Edit form -->
                    <div class="cs-stat">
                        <span class="label">Adapter Type</span>
                        <InputSelect @bind-Value="_edit.PreferredTransport">
                            <option value="BLE">BLE</option>
                            <option value="WiFi">WiFi</option>
                            <option value="USB">USB</option>
                        </InputSelect>
                    </div>

                    <div class="cs-stat">
                        <span class="label">Adapter Name</span>
                        <InputText @bind-Value="_edit.PreferredAdapterName" placeholder="e.g., VEEPEAK" />
                    </div>

                    <div class="cs-stat">
                        <span class="label">Redline Start</span>
                        <InputNumber @bind-Value="_edit.TachRedlineStart" />
                    </div>

                    <div class="cs-stat">
                        <span class="label">Redline End</span>
                        <InputNumber @bind-Value="_edit.TachMaxRpm" />
                    </div>

                    <div class="cs-stat">
                        <span class="label">Max Speed (mph)</span>
                        <InputNumber @bind-Value="_edit.SpeedMaxMph" />
                    </div>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button class="cs-btn primary" @onclick="() => SaveEdit(c)">💾 Save</button>
                        <button class="cs-btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                }
                else
                {
                    <!-- Read-only stats -->
                    <div class="cs-stat">
                        <span class="label">Adapter Type</span>
                        <span class="value">@DisplayTransport(c.PreferredTransport)</span>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(c.PreferredAdapterName))
                    {
                        <div class="cs-stat">
                            <span class="label">Adapter Name</span>
                            <span class="value">@c.PreferredAdapterName</span>
                        </div>
                    }

                    @if ((c.TachRedlineStart ?? c.TachMaxRpm) is int redStart)
                    {
                        <div class="cs-stat">
                            <span class="label">Redline Start</span>
                            <span class="value">@redStart rpm</span>
                        </div>
                    }

                    @if (c.TachMaxRpm.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Redline End</span>
                            <span class="value">@c.TachMaxRpm rpm</span>
                        </div>
                    }

                    @if (c.SpeedMaxMph.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Max Speed</span>
                            <span class="value">@c.SpeedMaxMph mph</span>
                        </div>
                    }

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button class="cs-btn primary" @onclick="() => MakeActive(c)">Set Active</button>
                        <button class="cs-btn" @onclick="() => StartEdit(c)">✏️ Edit</button>
                        <button class="cs-btn btn-secondary" @onclick="() => Delete(c)">Delete</button>
                    </div>
                }
            </section>
        }
    </div>
}

@code {
    private List<VehicleProfile>? _cars;

    // --- Edit state ---
    private string? _editingKey; // Year|Make|Model
    private EditDto _edit = new();

    private sealed class EditDto
    {
        public string PreferredTransport { get; set; } = "BLE";
        public string? PreferredAdapterName { get; set; }
        public int? TachMaxRpm { get; set; }
        public int? TachRedlineStart { get; set; }
        public int? SpeedMaxMph { get; set; }
    }

    private static string KeyOf(VehicleProfile v) => $"{v.Year}|{v.Make}|{v.Model}";
    private bool IsEditing(VehicleProfile v) => _editingKey == KeyOf(v);

    protected override async Task OnInitializedAsync()
    {
        // Ensure Profiles.Current is loaded from storage
        await Profiles.LoadAsync();

        _cars = await Storage.GetAsync<List<VehicleProfile>>(AppKeys.VehicleProfiles)
                ?? new List<VehicleProfile>();

        // Seed once from current profile if list is empty
        if (_cars.Count == 0)
        {
            var current = await Storage.GetAsync<VehicleProfile>(AppKeys.VehicleProfile);
            if (current is not null && !_cars.Any(v => SameCar(v, current)))
            {
                _cars.Add(current);
                await Storage.SetAsync(AppKeys.VehicleProfiles, _cars);
            }
        }
    }

    private void AddNew() => Nav.NavigateTo("/setup");

    private async Task MakeActive(VehicleProfile v)
    {
        await Storage.SetAsync(AppKeys.VehicleProfile, v);
        await Storage.SetAsync(AppKeys.SetupCompleted, true);
        Profiles.Set(v); // keep memory Current in sync
        StateHasChanged();
    }

    private void StartEdit(VehicleProfile v)
    {
        _editingKey = KeyOf(v);
        _edit = new EditDto
        {
            PreferredTransport   = string.IsNullOrWhiteSpace(v.PreferredTransport) ? "BLE" : v.PreferredTransport,
            PreferredAdapterName = v.PreferredAdapterName,
            TachMaxRpm           = v.TachMaxRpm,
            TachRedlineStart     = v.TachRedlineStart,
            SpeedMaxMph          = v.SpeedMaxMph
        };
    }

    private void CancelEdit()
    {
        _editingKey = null;
        _edit = new();
    }

    private async Task SaveEdit(VehicleProfile original)
    {
        if (_cars is null) return;

        // Build a NEW VehicleProfile (init-only props)
        var updated = new VehicleProfile
        {
            Year = original.Year,
            Make = original.Make,
            Model = original.Model,
            Engine = original.Engine,

            PreferredTransport   = _edit.PreferredTransport,
            PreferredAdapterName = _edit.PreferredAdapterName,

            ProtocolHint = original.ProtocolHint,
            InitScript = original.InitScript?.ToList() ?? new(),
            DesiredMode01Pids = original.DesiredMode01Pids?.ToList() ?? new(),

            TachMaxRpm = _edit.TachMaxRpm,
            TachRedlineStart = _edit.TachRedlineStart,
            SpeedMaxMph = _edit.SpeedMaxMph
        };

        // Replace in garage list
        var i = _cars.FindIndex(c => SameCar(c, original));
        if (i >= 0) _cars[i] = updated;

        // Persist garage
        await Storage.SetAsync(AppKeys.VehicleProfiles, _cars);

        // If this was the active car, update active storage too
        var current = await Storage.GetAsync<VehicleProfile>(AppKeys.VehicleProfile);
        if (current is not null && SameCar(current, original))
        {
            await Storage.SetAsync(AppKeys.VehicleProfile, updated);
            Profiles.Set(updated);
        }

        CancelEdit();
        StateHasChanged();
    }

    private static bool SameCar(VehicleProfile a, VehicleProfile b) =>
        a.Year == b.Year && a.Make == b.Make && a.Model == b.Model;

    private async Task Delete(VehicleProfile v)
    {
        if (_cars is null) return;

        _cars.RemoveAll(x => SameCar(x, v));
        await Storage.SetAsync(AppKeys.VehicleProfiles, _cars);

        var current = await Storage.GetAsync<VehicleProfile>(AppKeys.VehicleProfile);
        if (current is not null && SameCar(current, v))
        {
            await Storage.RemoveAsync(AppKeys.VehicleProfile);
            await Storage.RemoveAsync(AppKeys.SetupCompleted);

            if (_cars.Count > 0)
            {
                var next = _cars[0];
                await Storage.SetAsync(AppKeys.VehicleProfile, next);
                await Storage.SetAsync(AppKeys.SetupCompleted, true);
                Profiles.Set(next);
            }
            else
            {
                Profiles.Set(new VehicleProfile());
            }
        }

        StateHasChanged();
    }

    private static string DisplayTransport(string? t)
        => string.IsNullOrWhiteSpace(t) ? "BLE" : t;
}