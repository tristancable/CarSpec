@page "/setup"
@using Microsoft.AspNetCore.Components.Forms
@using CarSpec.Models
@using CarSpec.Constants
@inject CarSpec.Interfaces.IVehicleProfileService Profiles
@inject CarSpec.Interfaces.IAppStorage Storage
@inject NavigationManager Nav

<h2 class="cs-title" style="margin:6px 0 12px">Vehicle Setup</h2>

<EditForm Model="form" OnValidSubmit="Save">
    <DataAnnotationsValidator />
    <div class="cs-card setup-card">
        <div class="setup-header">
            <div>
                <h3 class="setup-title">Vehicle Setup</h3>
                <p class="setup-sub">
                    Enter your car once. We’ll detect protocol & PIDs automatically on the first successful connection and save them to this profile.
                </p>
            </div>
            <div class="setup-badge">Step 1 of 1</div>
        </div>

        <div class="form-grid">
            <!-- Free-entry basics (no catalog) -->
            <div class="form-row">
                <label>Year</label>
                <InputText class="cs-input" @bind-Value="form.Year" placeholder="e.g., 2002" />
            </div>

            <div class="form-row">
                <label>Make</label>
                <InputText class="cs-input" @bind-Value="form.Make" placeholder="e.g., Subaru" />
            </div>

            <div class="form-row">
                <label>Model</label>
                <InputText class="cs-input" @bind-Value="form.Model" placeholder="e.g., WRX" />
            </div>

            <!-- Optional adapter nickname (helps scanning) -->
            <div class="form-row span-2">
                <label>Bluetooth OBD Name <span class="hint">(optional)</span></label>
                <InputText class="cs-input" @bind-Value="form.AdapterNamePrimary" placeholder="e.g., VEEPEAK" />
            </div>

            <!-- Optional performance presets -->
            <div class="form-row">
                <label>Redline Start <span class="unit">rpm</span> <span class="hint">(optional)</span></label>
                <InputNumber class="cs-input" @bind-Value="form.RedlineStart" placeholder="(default 7000)" />
            </div>

            <div class="form-row">
                <label>Redline End / Max RPM <span class="hint">(optional)</span></label>
                <InputNumber class="cs-input" @bind-Value="form.RedlineEnd" placeholder="(default 9000)" />
            </div>

            <div class="form-row">
                <label>Max Speed <span class="unit">mph</span> <span class="hint">(optional)</span></label>
                <InputNumber class="cs-input" @bind-Value="form.MaxSpeedMph" placeholder="(default 140)" />
            </div>
        </div>

        <div class="actions">
            <button class="cs-btn primary" type="submit" disabled="@(!CanSave())">Save</button>
            <button class="cs-btn btn-secondary" type="button" @onclick="Cancel">Cancel</button>
        </div>
    </div>
</EditForm>

@code {
    private sealed class VehicleForm
    {
        public string? Year { get; set; }
        public string? Make { get; set; }
        public string? Model { get; set; }
        public string? AdapterNamePrimary { get; set; }
        public int? RedlineStart { get; set; }
        public int? RedlineEnd { get; set; }
        public int? MaxSpeedMph { get; set; }
    }

    private VehicleForm form = new();

    private bool CanSave() =>
        !string.IsNullOrWhiteSpace(form.Year) &&
        !string.IsNullOrWhiteSpace(form.Make) &&
        !string.IsNullOrWhiteSpace(form.Model);

    private async Task Save()
    {
        if (!CanSave()) return;

        int redlineStart = form.RedlineStart ?? 7000;
        int redlineEnd = form.RedlineEnd ?? 9000;
        int maxSpeedMph = form.MaxSpeedMph ?? 140;

        if (redlineEnd <= redlineStart)
            redlineEnd = Math.Max(redlineStart + 500, 6000);

        var vp = new VehicleProfile
        {
            Year = form.Year!.Trim(),
            Make = form.Make!.Trim(),
            Model = form.Model!.Trim(),

            // user hint for BLE scan (optional)
            PreferredAdapterName = string.IsNullOrWhiteSpace(form.AdapterNamePrimary) ? null : form.AdapterNamePrimary!.Trim(),

            // optional gauge prefs
            TachRedlineStart = redlineStart,
            TachMaxRpm = redlineEnd,
            SpeedMaxMph = maxSpeedMph,

            // DO NOT set PreferredTransport/ProtocolHint here.
            // ObdConnectionService will learn & persist these after first connect.
        };

        await Profiles.AddAsync(vp);
        await Profiles.SetCurrentAsync(vp);
        await Storage.SetAsync(AppKeys.SetupCompleted, true);

        Nav.NavigateTo("/garage");
    }

    private void Cancel() => Nav.NavigateTo("/garage");
}