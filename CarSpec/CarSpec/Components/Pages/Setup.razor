@page "/setup"
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using CarSpec.Models
@using CarSpec.Constants
@inject CarSpec.Interfaces.IVehicleProfileService Profiles
@inject CarSpec.Interfaces.IAppStorage Storage
@inject NavigationManager Nav

<h2 class="cs-title" style="margin:6px 0 12px">Vehicle Setup</h2>

<EditForm Model="form" OnValidSubmit="Save">
    <DataAnnotationsValidator />
    @* <ValidationSummary /> *@

    <div class="cs-card setup-card">
        <div class="setup-header">
            <div>
                <h3 class="setup-title">Vehicle Setup</h3>
                <p class="setup-sub">
                    Enter your car once. We’ll detect protocol &amp; PIDs automatically on the first successful connection and save them to this profile.
                </p>
            </div>
            <div class="setup-badge">Step 1 of 1</div>
        </div>

        <div class="setup-banner" style="margin:0 0 12px 0">
          <div style="display:flex;align-items:flex-start;gap:12px">
            <div class="icon">💡</div>
            <div>
              <strong>Need your adapter’s exact Bluetooth name?</strong>
              Open the <a href="/BleScan">Bluetooth</a> page to scan for devices (e.g., <code>VEEPEAK</code>, <code>OBDII</code>).
            </div>
          </div>
        </div>

        <div class="form-grid">
            <div class="form-row">
                <label>Nickname <span class="hint hint--optional">(optional)</span></label>
                <InputText class="cs-input cs-input--field" @bind-Value="form.ProfileName" placeholder="e.g., My Rally Car" />
                <ValidationMessage For="@(() => form.ProfileName)" />
            </div>

            <div class="form-row">
                <label>Year <span class="hint hint--required">(required)</span></label>
                <InputText class="cs-input cs-input--field" @bind-Value="form.Year" placeholder="e.g., 2002" />
                <ValidationMessage For="@(() => form.Year)" />
            </div>

            <div class="form-row">
                <label>Make <span class="hint hint--required">(required)</span></label>
                <InputText class="cs-input cs-input--field" @bind-Value="form.Make" placeholder="e.g., Subaru" />
                <ValidationMessage For="@(() => form.Make)" />
            </div>

            <div class="form-row">
                <label>Model <span class="hint hint--required">(required)</span></label>
                <InputText class="cs-input cs-input--field" @bind-Value="form.Model" placeholder="e.g., WRX" />
                <ValidationMessage For="@(() => form.Model)" />
            </div>

            <div class="form-row">
                <label>
                    Mileage
                    <span class="unit">mi</span>
                    <span class="hint hint--optional">(optional)</span>
                </label>

                <InputNumber class="cs-input cs-input--field"
                             @bind-Value="form.OdometerMiles"
                             placeholder="e.g., 145000" />

                <ValidationMessage For="@(() => form.OdometerMiles)" />
            </div>

            <div class="form-row span-2">
                <label>Bluetooth OBD Name <span class="hint hint--required">(required)</span></label>
                <InputText class="cs-input cs-input--field" @bind-Value="form.AdapterNamePrimary" placeholder="Exact advertised name (e.g., VEEPEAK)" />
                <ValidationMessage For="@(() => form.AdapterNamePrimary)" />
                <small style="opacity:.85">Must match what your device shows during Bluetooth scan.</small>
            </div>

            <div class="form-row">
                <label>Redline Start <span class="unit">rpm</span> <span class="hint hint--optional">(optional)</span></label>
                <InputNumber class="cs-input cs-input--field" @bind-Value="form.RedlineStart" placeholder="(default 7000)" />
                <ValidationMessage For="@(() => form.RedlineStart)" />
            </div>

            <div class="form-row">
                <label>Redline End / Max RPM <span class="hint hint--optional">(optional)</span></label>
                <InputNumber class="cs-input cs-input--field" @bind-Value="form.RedlineEnd" placeholder="(default 9000)" />
                <ValidationMessage For="@(() => form.RedlineEnd)" />
            </div>

            <div class="form-row">
                <label>Max Speed <span class="unit">mph</span> <span class="hint hint--optional">(optional)</span></label>
                <InputNumber class="cs-input cs-input--field" @bind-Value="form.MaxSpeedMph" placeholder="(default 160)" />
                <ValidationMessage For="@(() => form.MaxSpeedMph)" />
            </div>
        </div>

        <div class="actions">
            <button class="cs-btn primary" type="submit"">Save</button>
            <button class="cs-btn btn-secondary" type="button" @onclick="Cancel">Cancel</button>
        </div>
    </div>
</EditForm>

@code {
    [SupplyParameterFromQuery(Name = "new")]
    public bool? New { get; set; }
    private bool IsCreate => New == true;

    private sealed class VehicleForm
    {
        public string? ProfileName { get; set; }

        [Required(ErrorMessage = "Year is required")]
        public string? Year { get; set; }

        [Required(ErrorMessage = "Make is required")]
        public string? Make { get; set; }

        [Required(ErrorMessage = "Model is required")]
        public string? Model { get; set; }

        [Range(0, 2000000, ErrorMessage = "Mileage must be a positive number")]
        public int? OdometerMiles { get; set; }

        [Required(ErrorMessage = "Bluetooth OBD Name is required")]
        [MinLength(2, ErrorMessage = "Adapter name looks too short")]
        public string? AdapterNamePrimary { get; set; }

        [Range(0, 12000, ErrorMessage = "Redline start must be between 0 and 12000 rpm.")]
        public int? RedlineStart { get; set; }

        [Range(0, 12000, ErrorMessage = "Redline max must be between 0 and 12000 rpm.")]
        public int? RedlineEnd { get; set; }

        [Range(0, 400, ErrorMessage = "Max speed must be between 0 and 400 mph.")]
        public int? MaxSpeedMph { get; set; }
    }

    private VehicleForm form = new();

    private bool CanSave() =>
        !string.IsNullOrWhiteSpace(form.Year) &&
        !string.IsNullOrWhiteSpace(form.Make) &&
        !string.IsNullOrWhiteSpace(form.Model) &&
        !string.IsNullOrWhiteSpace(form.AdapterNamePrimary);

    protected override async Task OnInitializedAsync()
    {
        await Profiles.LoadAsync();
        var cur = Profiles.Current;

        if (!IsCreate && cur is not null)
        {
            form.ProfileName        = cur.ProfileName;
            form.Year               = cur.Year;
            form.Make               = cur.Make;
            form.Model              = cur.Model;
            form.OdometerMiles      = cur.OdometerMiles;
            form.AdapterNamePrimary = cur.PreferredAdapterName;
            form.RedlineStart       = cur.TachRedlineStart;
            form.RedlineEnd         = cur.TachMaxRpm;
            form.MaxSpeedMph        = cur.SpeedMaxMph;
        }
        else
        {
            form = new VehicleForm();
        }
    }

    private async Task Save()
    {
        if (!CanSave()) return;

        int redlineStart = form.RedlineStart ?? 7000;
        int redlineEnd   = form.RedlineEnd   ?? 9000;
        int maxSpeedMph  = form.MaxSpeedMph ?? 160;
        if (redlineEnd <= redlineStart) redlineEnd = Math.Max(redlineStart + 500, 6000);

        await Profiles.LoadAsync();

        if (IsCreate || Profiles.Current is null)
        {
            var vp = new VehicleProfile {
                Id = Guid.NewGuid().ToString("N"),
                ProfileName = form.ProfileName?.Trim(),
                Year = form.Year!.Trim(),
                Make = form.Make!.Trim(),
                Model = form.Model!.Trim(),
                OdometerMiles     = form.OdometerMiles,
                OdometerUpdatedUtc = form.OdometerMiles.HasValue ? DateTime.UtcNow : null,
                PreferredAdapterName = form.AdapterNamePrimary!.Trim(),
                TachRedlineStart = redlineStart,
                TachMaxRpm       = redlineEnd,
                SpeedMaxMph      = maxSpeedMph,

                ProtocolDetected   = null,
                SupportedPidsCache = null,
                LastConnectedUtc   = default
            };

            await Profiles.AddAsync(vp);
            await Profiles.SetCurrentAsync(vp);
        }
        else
        {
            var vp = Profiles.Current!;
            vp.ProfileName = form.ProfileName?.Trim();
            vp.Year = form.Year!.Trim();
            vp.Make = form.Make!.Trim();
            vp.Model = form.Model!.Trim();
            vp.OdometerMiles = form.OdometerMiles;
            if (form.OdometerMiles.HasValue)
            {
                vp.OdometerUpdatedUtc = DateTime.UtcNow;
            }
            vp.PreferredAdapterName = form.AdapterNamePrimary!.Trim();
            vp.TachRedlineStart = redlineStart;
            vp.TachMaxRpm       = redlineEnd;
            vp.SpeedMaxMph      = maxSpeedMph;

            await Profiles.SetCurrentAsync(vp);
        }

        await Storage.SetAsync(AppKeys.SetupCompleted, true);
        await Storage.SetAsync(AppKeys.VehicleProfile, true);

        Nav.NavigateTo("/garage");
    }

    private void OpenBleTest() => Nav.NavigateTo("/blescan");
    private void Cancel() => Nav.NavigateTo("/garage");
}