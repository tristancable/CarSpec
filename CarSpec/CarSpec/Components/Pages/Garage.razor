@page "/garage"
@using CarSpec.Models
@using CarSpec.Constants
@using Microsoft.AspNetCore.Components.Forms
@inject CarSpec.Interfaces.IAppStorage Storage
@inject CarSpec.Interfaces.IVehicleProfileService Profiles
@inject NavigationManager Nav

<h2 class="cs-title">My Garage</h2>

@if (Profiles.Current is VehicleProfile cur && !string.IsNullOrWhiteSpace(cur.Model))
{
    <p>Active Vehicle: <strong>@cur.Year @cur.Make @cur.Model</strong></p>
}
@* else
{
    <div class="cs-card warn" style="margin-bottom:12px">
        No cars yet. <a href="/setup">Add one</a>
    </div>
} *@

@if (_cars is null)
{
    <p>Loading…</p>
}
else if (_cars.Count == 0)
{
    <div class="cs-card warn">No cars yet. <a href="/setup">Add one</a></div>
}
else
{
    <div style="margin:12px 0">
        <button class="cs-btn primary" @onclick="AddNew">➕ Add another car</button>
    </div>

    <div class="cs-grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
        @foreach (var c in _cars)
        {
            <section class="cs-card">
                <h3>@c.Year @c.Make @c.Model</h3>

                @if (IsEditing(c))
                {
                    <!-- Edit form -->
                    <div class="cs-stat">
                        <span class="label">Adapter Name</span>
                        <InputText @bind-Value="_edit.PreferredAdapterName" placeholder="e.g., VEEPEAK" />
                    </div>

                    <div class="cs-stat">
                        <span class="label">Redline Start</span>
                        <InputNumber @bind-Value="_edit.TachRedlineStart" />
                    </div>

                    <div class="cs-stat">
                        <span class="label">Redline End</span>
                        <InputNumber @bind-Value="_edit.TachMaxRpm" />
                    </div>

                    <div class="cs-stat">
                        <span class="label">Max Speed (mph)</span>
                        <InputNumber @bind-Value="_edit.SpeedMaxMph" />
                    </div>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button class="cs-btn primary" @onclick="() => SaveEdit(c)">💾 Save</button>
                        <button class="cs-btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                }
                else
                {
                    <!-- Read-only stats -->
                    <div class="cs-stat">
                        <span class="label">Adapter Type</span>
                        <span class="value">@DisplayTransport(c.PreferredTransport)</span>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(c.PreferredAdapterName))
                    {
                        <div class="cs-stat">
                            <span class="label">Adapter Name</span>
                            <span class="value">@c.PreferredAdapterName</span>
                        </div>
                    }

                    @if ((c.TachRedlineStart ?? c.TachMaxRpm) is int redStart)
                    {
                        <div class="cs-stat">
                            <span class="label">Redline Start</span>
                            <span class="value">@redStart rpm</span>
                        </div>
                    }

                    @if (c.TachMaxRpm.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Redline End</span>
                            <span class="value">@c.TachMaxRpm rpm</span>
                        </div>
                    }

                    @if (c.SpeedMaxMph.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Max Speed</span>
                            <span class="value">@c.SpeedMaxMph mph</span>
                        </div>
                    }

                    <hr style="opacity:.25" />

                    <!-- Learned on first successful connection -->
                    <details style="margin-top:8px">
                        <summary class="cs-link">Show learned ECU details</summary>
                        @if (!string.IsNullOrWhiteSpace(c.PreferredTransport))
                        {
                            <div class="cs-stat">
                                <span class="label">Adapter Type (preferred)</span>
                                <span class="value">@c.PreferredTransport</span>
                            </div>
                        }
                        ))

                        @if (!string.IsNullOrWhiteSpace(c.ProtocolDetected))
                        {
                            <div class="cs-stat">
                                <span class="label">Protocol (detected)</span>
                                <span class="value">@c.ProtocolDetected</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(c.VinLast))
                        {
                            <div class="cs-stat">
                                <span class="label">VIN</span>
                                <span class="value">@c.VinLast</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(c.WmiLast))
                        {
                            <div class="cs-stat">
                                <span class="label">WMI</span>
                                <span class="value">@c.WmiLast</span>
                            </div>
                        }

                        @if (c.YearDetected is int yd)
                        {
                            <div class="cs-stat">
                                <span class="label">Year (from VIN)</span>
                                <span class="value">@yd</span>
                            </div>
                        }

                        @if (c.CalIds is { Count: > 0 })
                        {
                            <div class="cs-stat">
                                <span class="label">CAL IDs</span>
                                <span class="value">@PreviewList(c.CalIds)</span>
                            </div>
                        }

                        @if (c.SupportedPidsCache is { Count: > 0 })
                        {
                            <div class="cs-stat">
                                <span class="label">Supported PIDs</span>
                                <span class="value">@($"{c.SupportedPidsCache.Count} total — " + PreviewList(c.SupportedPidsCache, 8))</span>
                            </div>
                        }

                        @if (c.DesiredMode01Pids is { Count: > 0 })
                        {
                            <div class="cs-stat">
                                <span class="label">Desired PIDs</span>
                                <span class="value">@PreviewList(c.DesiredMode01Pids, 8)</span>
                            </div>
                        }

                        @if (c.LastConnectedUtc != default)
                        {
                            <div class="cs-stat">
                                <span class="label">Last Connected</span>
                                <span class="value">@FormatUtc(c.LastConnectedUtc)</span>
                            </div>
                        }
                    </details>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button class="cs-btn primary" @onclick="() => MakeActive(c)">Set Active</button>
                        <button class="cs-btn" @onclick="() => StartEdit(c)">✏️ Edit</button>
                        <button class="cs-btn btn-secondary" @onclick="() => Delete(c)">Delete</button>
                    </div>
                }
            </section>
        }
    </div>
}

@code {
    private List<VehicleProfile>? _cars;

    // --- Edit state ---
    private string? _editingKey; // Year|Make|Model
    private EditDto _edit = new();

    private sealed class EditDto
    {
        public string? PreferredAdapterName { get; set; }
        public int? TachMaxRpm { get; set; }
        public int? TachRedlineStart { get; set; }
        public int? SpeedMaxMph { get; set; }
    }

    private static string KeyOf(VehicleProfile v) => $"{v.Year}|{v.Make}|{v.Model}";
    private bool IsEditing(VehicleProfile v) => _editingKey == KeyOf(v);

    protected override async Task OnInitializedAsync()
    {
        await Profiles.LoadAsync();
        // Pull from the profile service (user garage)
        _cars = await Profiles.GetAllAsync();

        // If empty, seed from Current once (keeps your original behavior)
        if (_cars.Count == 0 && Profiles.Current is VehicleProfile cur && !string.IsNullOrWhiteSpace(cur.Model))
        {
            await Profiles.AddAsync(cur);
            _cars = await Profiles.GetAllAsync();
        }
    }

    private void AddNew() => Nav.NavigateTo("/setup");

    private async Task MakeActive(VehicleProfile v)
    {
        await Profiles.SetCurrentAsync(v);
        await Storage.SetAsync(AppKeys.SetupCompleted, true);
        StateHasChanged();
    }

    private void StartEdit(VehicleProfile v)
    {
        _editingKey = KeyOf(v);
        _edit = new EditDto
        {
            PreferredAdapterName = v.PreferredAdapterName,
            TachMaxRpm = v.TachMaxRpm,
            TachRedlineStart = v.TachRedlineStart,
            SpeedMaxMph = v.SpeedMaxMph
        };
    }

    private void CancelEdit()
    {
        _editingKey = null;
        _edit = new();
    }

    private async Task SaveEdit(VehicleProfile original)
    {
        if (_cars is null) return;

        var updated = new VehicleProfile
        {
            Id = string.IsNullOrWhiteSpace(original.Id) ? Guid.NewGuid().ToString("N") : original.Id,
            Year = original.Year,
            Make = original.Make,
            Model = original.Model,
            Engine = original.Engine,

            // editable in the UI
            PreferredTransport = original.PreferredTransport,
            PreferredAdapterName = _edit.PreferredAdapterName,
            TachMaxRpm = _edit.TachMaxRpm,
            TachRedlineStart = _edit.TachRedlineStart,
            SpeedMaxMph = _edit.SpeedMaxMph,

            // keep any previously learned/advanced settings
            ProtocolHint = original.ProtocolHint,
            ProtocolDetected = original.ProtocolDetected,
            InitScript = original.InitScript?.ToList() ?? new(),
            DesiredMode01Pids = original.DesiredMode01Pids?.ToList() ?? new(),
            SupportedPidsCache = original.SupportedPidsCache?.ToList(),
            VinLast = original.VinLast,
            WmiLast = original.WmiLast,
            YearDetected = original.YearDetected,
            CalIds = original.CalIds?.ToList(),
            LastConnectedUtc = original.LastConnectedUtc
        };

        var i = _cars.FindIndex(c => SameCar(c, original));
        if (i >= 0) _cars[i] = updated;

        await Storage.SetAsync(AppKeys.VehicleProfiles, _cars);

        if (Profiles.Current is not null && SameCar(Profiles.Current, original))
            await Profiles.SetCurrentAsync(updated);

        await Profiles.LoadAsync();

        CancelEdit();
        StateHasChanged();
    }

    private static bool SameCar(VehicleProfile a, VehicleProfile b) =>
        a.Year == b.Year && a.Make == b.Make && a.Model == b.Model;

    private async Task Delete(VehicleProfile v)
    {
        if (_cars is null) return;

        // Remove from service (preferred)
        // If your service doesn’t have Remove by Y/M/M, use Id when available
        if (!string.IsNullOrWhiteSpace(v.Id))
        {
            await Profiles.RemoveAsync(v.Id);
        }
        else
        {
            // fallback: manual prune + persist (matches your original logic)
            _cars.RemoveAll(x => SameCar(x, v));
            await Storage.SetAsync(AppKeys.VehicleProfiles, _cars);
        }

        // If we deleted the active one, pick another (original behavior)
        if (Profiles.Current is not null && SameCar(Profiles.Current, v))
        {
            var fresh = await Profiles.GetAllAsync();
            if (fresh.Count > 0)
            {
                await Profiles.SetCurrentAsync(fresh[0]);
                await Storage.SetAsync(AppKeys.SetupCompleted, true);
            }
            else
            {
                Profiles.Set(new VehicleProfile());
                await Storage.RemoveAsync(AppKeys.VehicleProfile);
                await Storage.RemoveAsync(AppKeys.SetupCompleted);
            }
        }

        // Reload for UI
        _cars = await Profiles.GetAllAsync();
        StateHasChanged();
    }

    private static string DisplayTransport(string? t)
    {
        if (string.IsNullOrWhiteSpace(t)) return "Auto";
        return t; // e.g., "BLE", "WIFI", "USB"
    }

    private static string PreviewList(IEnumerable<string>? items, int max = 5)
    {
        if (items is null) return "—";
        var list = items.Where(s => !string.IsNullOrWhiteSpace(s)).ToList();
        if (list.Count == 0) return "—";
        var head = list.Take(max).ToList();
        return head.Count == list.Count
            ? string.Join(", ", head)
            : $"{string.Join(", ", head)} … (+{list.Count - head.Count})";
    }

    private static string FormatUtc(DateTime? dt)
    {
        if (dt is null || dt == default) return "—";
        // Show local time nicely; fallback to UTC if needed
        var local = dt.Value.ToLocalTime();
        return local.ToString("yyyy-MM-dd HH:mm");
    }
}