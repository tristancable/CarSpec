@page "/garage"
@using CarSpec.Models
@using CarSpec.Constants
@using CarSpec.Utils.OBDData
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@inject CarSpec.Interfaces.IAppStorage Storage
@inject CarSpec.Interfaces.IVehicleProfileService Profiles
@inject NavigationManager Nav

<h2 class="cs-title">My Garage</h2>

@* @if (Profiles.Current is VehicleProfile cur && !string.IsNullOrWhiteSpace(cur.Model))
{
    <p>Active Vehicle: <strong>@cur.Year @cur.Make @cur.Model</strong></p>
} *@

@if (_cars is null)
{
    <p>Loading…</p>
}
else if (_cars.Count == 0)
{
    <div class="cs-card warn">No cars yet. <a href="/setup?new=true">Add one</a></div>
}
else
{
    <div style="margin:12px 0">
        <button class="cs-btn primary" @onclick="AddNew">➕ Add another car</button>
    </div>

    <div class="cs-grid" style="grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
        @foreach (var c in _cars)
        {
            <section class="cs-card">
                <h3>@c.Year @c.Make @c.Model</h3>

                @if (IsEditing(c))
                {
                    <!-- Edit form -->
                    <EditForm EditContext="_editContext" OnValidSubmit="@(() => SaveEdit(c))">
                        <DataAnnotationsValidator />

                        <div class="cs-stat cs-stat--field">
                            <span class="label">Nickname</span>
                            <div class="value value--field">
                                <InputText @bind-Value="_edit.ProfileName" class="cs-input cs-input--stat" />
                            </div>
                        </div>

                        <div class="cs-stat cs-stat--field">
                            <span class="label">Odometer (mi)</span>
                            <div class="value value--field">
                                <InputNumber @bind-Value="_edit.OdometerMiles" class="cs-input cs-input--stat" />
                            </div>
                        </div>

                        <div class="cs-stat cs-stat--field">
                            <span class="label">Adapter Name</span>
                            <div class="value value--field">
                                <InputText @bind-Value="_edit.PreferredAdapterName"
                                           class="cs-input cs-input--stat"
                                           placeholder="e.g., VEEPEAK" />
                            </div>
                        </div>

                        <div class="cs-stat cs-stat--field">
                            <span class="label">Redline Start</span>
                            <div class="value value--field">
                                <InputNumber @bind-Value="_edit.TachRedlineStart"
                                             class="cs-input cs-input--stat" />
                                <ValidationMessage For="@(() => _edit.TachRedlineStart)" />
                            </div>
                        </div>


                        <div class="cs-stat cs-stat--field">
                            <span class="label">Redline End</span>
                            <div class="value value--field">
                                <InputNumber @bind-Value="_edit.TachMaxRpm"
                                             class="cs-input cs-input--stat" />
                                <ValidationMessage For="@(() => _edit.TachMaxRpm)" />
                            </div>
                        </div>

                        <div class="cs-stat cs-stat--field">
                            <span class="label">Max Speed (mph)</span>
                            <div class="value value--field">
                                <InputNumber @bind-Value="_edit.SpeedMaxMph"
                                             class="cs-input cs-input--stat" />
                                <ValidationMessage For="@(() => _edit.SpeedMaxMph)" />
                            </div>
                        </div>

                        <div style="display:flex;gap:8px;margin-top:10px">
                            <button class="cs-btn primary" type="submit">Save</button>
                            <button class="cs-btn btn-secondary" type="button" @onclick="CancelEdit">Cancel</button>
                        </div>
                    </EditForm>
                }
                else
                {
                    <!-- Read-only stats -->
                    @* <div class="cs-stat">
                        <span class="label">Adapter Type</span>
                        <span class="value">@DisplayTransport(c.PreferredTransport)</span>
                    </div> *@

                    @if (!string.IsNullOrWhiteSpace(c.ProfileName))
                    {
                        <div class="cs-stat">
                            <span class="label">Nickname</span>
                            <span class="value">@c.ProfileName</span>
                        </div>
                    }

                    @if (c.OdometerMiles.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Odometer</span>
                            <span class="value">@c.OdometerMiles.Value.ToString("N0") mi</span>
                        </div>
                    }

                    @if (c.OdometerUpdatedUtc.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Mileage updated</span>
                            <span class="value">@c.OdometerUpdatedUtc.Value.ToLocalTime().ToString("yyyy-MM-dd")</span>
                        </div>
                    }

                    @if (!string.IsNullOrWhiteSpace(c.PreferredAdapterName))
                    {
                        <div class="cs-stat">
                            <span class="label">Adapter Name</span>
                            <span class="value">@c.PreferredAdapterName</span>
                        </div>
                    }

                    @if ((c.TachRedlineStart ?? c.TachMaxRpm) is int redStart)
                    {
                        <div class="cs-stat">
                            <span class="label">Redline Start</span>
                            <span class="value">@redStart rpm</span>
                        </div>
                    }

                    @if (c.TachMaxRpm.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Redline End</span>
                            <span class="value">@c.TachMaxRpm rpm</span>
                        </div>
                    }

                    @if (c.SpeedMaxMph.HasValue)
                    {
                        <div class="cs-stat">
                            <span class="label">Max Speed</span>
                            <span class="value">@c.SpeedMaxMph mph</span>
                        </div>
                    }

                    <hr style="opacity:.25" />

                    <details style="margin-top:8px">
                        <summary class="cs-link">Show learned ECU details</summary>
                        @if (!string.IsNullOrWhiteSpace(c.PreferredTransport))
                        {
                            <div class="cs-stat">
                                <span class="label">Adapter Type (preferred)</span>
                                <span class="value">@c.PreferredTransport</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(c.ProtocolDetected))
                        {
                            <div class="cs-stat">
                                <span class="label">Protocol (detected)</span>
                                <span class="value">@c.ProtocolDetected</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(c.VinLast))
                        {
                            <div class="cs-stat">
                                <span class="label">VIN</span>
                                <span class="value">@c.VinLast</span>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(c.WmiLast))
                        {
                            <div class="cs-stat">
                                <span class="label">WMI</span>
                                <span class="value">@c.WmiLast</span>
                            </div>
                        }

                        @if (c.YearDetected is int yd)
                        {
                            <div class="cs-stat">
                                <span class="label">Year (from VIN)</span>
                                <span class="value">@yd</span>
                            </div>
                        }

                        @if (c.CalIds is { Count: > 0 })
                        {
                            <div class="cs-stat">
                                <span class="label">CAL IDs</span>
                                <span class="value">@PreviewList(c.CalIds)</span>
                            </div>
                        }

                        @if (c.SupportedPidsCache is { Count: > 0 })
                        {
                            <div class="cs-stat">
                                <span class="label">Supported PIDs</span>
                                <span class="value">
                                    @c.SupportedPidsCache.Count total —
                                    <button class="cs-linkbtn" @onclick="() => OpenPidsModal(c)">View all</button>
                                </span>
                            </div>
                        }

                        @if (c.DesiredMode01Pids is { Count: > 0 })
                        {
                            <div class="cs-stat">
                                <span class="label">Desired PIDs</span>
                                <span class="value">@PreviewList(c.DesiredMode01Pids, 8)</span>
                            </div>
                        }

                        @if (c.LastConnectedUtc.HasValue)
                        {
                            <div class="cs-stat">
                                <span class="label">Last Connected</span>
                                <span class="value">@FormatUtc(c.LastConnectedUtc)</span>
                            </div>
                        }
                    </details>

                    <div style="display:flex;gap:8px;margin-top:10px">
                        <button class="cs-btn primary" @onclick="() => MakeActive(c)">Set Active</button>
                        <button class="cs-btn" @onclick="() => StartEdit(c)">Edit</button>
                        <button class="cs-btn btn-secondary" @onclick="() => Delete(c)">Delete</button>
                    </div>
                }
            </section>
        }
    </div>

    @if (_showPidsModal)
    {
        <div class="cs-modal-backdrop" @onclick="ClosePidsModal">
            <div class="cs-modal" @onclick:stopPropagation>
                <div class="cs-modal__head">
                    <h3 class="cs-modal__title cs-title">
                        Supported PIDs — @_modalTitle
                        <span class="cs-modal__count">(@_filteredPids.Count())</span>
                    </h3>
                </div>

                <div class="pid-toolbar">
                    <input class="pid-search" placeholder="Filter PIDs or names…"
                           @bind="_pidQuery" @bind:event="oninput" />
                </div>

                <div class="pid-scroll">
                    <div class="pid-grid">
                        @foreach (var (pid, name) in _filteredPids)
                        {
                            <div class="pid-chip @(name is null ? "pid-unknown" : null)">
                                <div class="pid-code">@pid</div>
                                <div class="pid-name">@((name ?? "Unknown"))</div>
                            </div>
                        }
                    </div>
                </div>

                <div class="cs-modal__foot">
                    <button class="cs-btn primary" @onclick="ClosePidsModal">Close</button>
                </div>
            </div>
        </div>
    }
}

@code {
    private List<VehicleProfile>? _cars;

    private string? _editingKey;
    private EditDto _edit = new();
    private bool _showPidsModal;
    private List<string> _modalPids = new();
    private string _modalTitle = string.Empty;
    private string _pidQuery = string.Empty;
    private List<(string pid, string? name)> _modalEntries = new();
    private EditContext? _editContext;

    private sealed class EditDto
    {
        public string? ProfileName { get; set; }
        public string? PreferredAdapterName { get; set; }

        [Range(0, 12000, ErrorMessage = "Redline start must be between 0 and 12000 rpm.")]
        public int? TachRedlineStart { get; set; }

        [Range(0, 12000, ErrorMessage = "Redline max must be between 0 and 12000 rpm.")]
        public int? TachMaxRpm { get; set; }

        [Range(0, 400, ErrorMessage = "Max speed must be between 0 and 400 mph.")]
        public int? SpeedMaxMph { get; set; }

        public int? OdometerMiles { get; set; }
    }

    private static string KeyOf(VehicleProfile v) => $"{v.Year}|{v.Make}|{v.Model}";
    private bool IsEditing(VehicleProfile v) => _editingKey == KeyOf(v);

    private async Task RefreshCarsAsync()
    {
        await Profiles.LoadAsync();
        _cars = await Profiles.GetAllAsync();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await RefreshCarsAsync();

        if (_cars!.Count == 0 && Profiles.Current is VehicleProfile cur && !string.IsNullOrWhiteSpace(cur.Model))
        {
            await Profiles.AddAsync(cur);
            await RefreshCarsAsync();
        }
    }

    private void AddNew() => Nav.NavigateTo("/setup?new=true");

    private async Task MakeActive(VehicleProfile v)
    {
        await Profiles.SetCurrentAsync(v);
        await Storage.SetAsync(AppKeys.SetupCompleted, true);
        StateHasChanged();
        await RefreshCarsAsync();
    }

    private void StartEdit(VehicleProfile v)
    {
        _editingKey = KeyOf(v);
        _edit = new EditDto
        {
            ProfileName = v.ProfileName,
            PreferredAdapterName = v.PreferredAdapterName,
            TachMaxRpm = v.TachMaxRpm,
            TachRedlineStart = v.TachRedlineStart,
            SpeedMaxMph = v.SpeedMaxMph,
            OdometerMiles = v.OdometerMiles,
        };

        _editContext = new EditContext(_edit);
    }

    private void CancelEdit()
    {
        _editingKey = null;
        _edit = new();
        _editContext = null;
    }

    private async Task SaveEdit(VehicleProfile original)
    {
        if (_cars is null) return;

        var updated = new VehicleProfile
        {
            Id = string.IsNullOrWhiteSpace(original.Id) ? Guid.NewGuid().ToString("N") : original.Id,
            ProfileName = _edit.ProfileName,
            Year = original.Year,
            Make = original.Make,
            Model = original.Model,
            Engine = original.Engine,

            PreferredTransport = original.PreferredTransport,
            PreferredAdapterName = _edit.PreferredAdapterName,
            TachMaxRpm = _edit.TachMaxRpm,
            TachRedlineStart = _edit.TachRedlineStart,
            SpeedMaxMph = _edit.SpeedMaxMph,

            OdometerMiles = _edit.OdometerMiles,
            OdometerUpdatedUtc = _edit.OdometerMiles.HasValue
                                    ? DateTime.UtcNow
                                    : original.OdometerUpdatedUtc,

            ProtocolHint = original.ProtocolHint,
            ProtocolDetected = original.ProtocolDetected,
            InitScript = original.InitScript?.ToList() ?? new(),
            DesiredMode01Pids = original.DesiredMode01Pids?.ToList() ?? new(),
            SupportedPidsCache = original.SupportedPidsCache?.ToList(),
            VinLast = original.VinLast,
            WmiLast = original.WmiLast,
            YearDetected = original.YearDetected,
            CalIds = original.CalIds?.ToList(),
            LastConnectedUtc = original.LastConnectedUtc
        };

        var i = _cars.FindIndex(c => SameCar(c, original));
        if (i >= 0) _cars[i] = updated;

        if (Profiles.Current is not null && SameCar(Profiles.Current, original))
            await Profiles.SetCurrentAsync(updated);

        await Profiles.LoadAsync();

        CancelEdit();
        StateHasChanged();
        await RefreshCarsAsync();
    }

    private static bool SameCar(VehicleProfile a, VehicleProfile b) =>
        a.Year == b.Year && a.Make == b.Make && a.Model == b.Model;

    private async Task Delete(VehicleProfile v)
    {
        if (_cars is null) return;

        if (!string.IsNullOrWhiteSpace(v.Id))
        {
            await Profiles.RemoveAsync(v.Id);
        }
        else
        {
            _cars.RemoveAll(x => SameCar(x, v));
        }

        if (Profiles.Current is not null && SameCar(Profiles.Current, v))
        {
            var fresh = await Profiles.GetAllAsync();
            if (fresh.Count > 0)
            {
                await Profiles.SetCurrentAsync(fresh[0]);
                await Storage.SetAsync(AppKeys.SetupCompleted, true);
            }
            else
            {
                Profiles.Set(new VehicleProfile());
                await Storage.RemoveAsync(AppKeys.VehicleProfile);
                await Storage.RemoveAsync(AppKeys.SetupCompleted);
            }
        }

        _cars = await Profiles.GetAllAsync();
        StateHasChanged();
        await RefreshCarsAsync();
    }

    private static string DisplayTransport(string? t)
    {
        if (string.IsNullOrWhiteSpace(t)) return "Auto";
        return t;
    }

    private static string PreviewList(IEnumerable<string>? items, int max = 5)
    {
        if (items is null) return "—";
        var list = items.Where(s => !string.IsNullOrWhiteSpace(s)).ToList();
        if (list.Count == 0) return "—";
        var head = list.Take(max).ToList();
        return head.Count == list.Count
            ? string.Join(", ", head)
            : $"{string.Join(", ", head)} … (+{list.Count - head.Count})";
    }

    private static string FormatUtc(DateTime? dt)
    {
        if (dt is null || dt == default) return "—";
        var local = dt.Value.ToLocalTime();
        return local.ToString("yyyy-MM-dd HH:mm");
    }

    private IEnumerable<(string pid, string? name)> _filteredPids =>
        string.IsNullOrWhiteSpace(_pidQuery)
            ? _modalEntries
            : _modalEntries.Where(e =>
                  e.pid.Contains(_pidQuery, StringComparison.OrdinalIgnoreCase) ||
                  (e.name?.Contains(_pidQuery, StringComparison.OrdinalIgnoreCase) ?? false));

    private void OpenPidsModal(VehicleProfile v)
    {
        var pids = (v.SupportedPidsCache ?? new List<string>())
            .Where(s => !string.IsNullOrWhiteSpace(s))
            .Select(s => s.Trim().ToUpperInvariant())
            .Distinct(StringComparer.OrdinalIgnoreCase)
            .OrderBy(s => s)
            .ToList();

        _modalEntries = pids
            .Select(pid => (pid, ObdPidCatalog.GetName(pid)))
            .ToList();

        _modalTitle = $"{v.Year} {v.Make} {v.Model}";
        _pidQuery = string.Empty;
        _showPidsModal = true;
    }

    private void ClosePidsModal()
    {
        _showPidsModal = false;
        _modalPids.Clear();
        _modalTitle = string.Empty;
    }
}