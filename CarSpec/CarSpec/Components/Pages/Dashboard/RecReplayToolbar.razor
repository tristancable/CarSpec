@using CarSpec.Models
@using CarSpec.Services.Telemetry

<div class="recplay-float">
    <div class="rec-toolbar">
        @* ── TOP ROW: selection + speed + delete ── *@
        <div class="rec-top-row cs-badge cs-badge--panel compact-chip">
            <select class="cs-input cs-input--sm"
                    style="min-width:160px"
                    value="@SelectedReplayId"
                    @onchange="HandleReplayChanged"
                    aria-label="Replay selection">
                <option value="">(none)</option>
                @foreach (var r in Replays)
                {
                    <option value="@r.Id">
                        @($"{(r.Vehicle ?? "Unknown")} — {FormatMs(r.DurationMs)} — {r.CreatedUtc.ToLocalTime():g}")
                    </option>
                }
            </select>

            <select class="cs-input cs-input--sm speed-dd"
                    @onchange="HandleReplaySpeedChanged"
                    aria-label="Replay speed">
                <option value="0.5" selected="@IsCurrentSpeed(0.5)">0.5×</option>
                <option value="1" selected="@IsCurrentSpeed(1)">1×</option>
                <option value="1.5" selected="@IsCurrentSpeed(1.5)">1.5×</option>
                <option value="2" selected="@IsCurrentSpeed(2)">2×</option>
                <option value="3" selected="@IsCurrentSpeed(3)">3×</option>
            </select>

            @* DELETE CURRENT RECORDING *@
            <button class="cs-iconbtn rec-transport-btn rec-delete-btn"
                    title="Delete this recording"
                    aria-label="Delete this recording"
                    @onclick="OnDeleteClicked"
                    disabled="@string.IsNullOrWhiteSpace(SelectedReplayId)">
                🗑
            </button>

            @* EXPORT CURRENT RECORDING *@
            <button class="cs-iconbtn rec-transport-btn"
                    title="Export this recording"
                    aria-label="Export this recording"
                    @onclick="OnExportClicked"
                    disabled="@string.IsNullOrWhiteSpace(SelectedReplayId)">
                ⬇
            </button>
        </div>

        @* ── PROGRESS ROW: scrub bar + timestamps ── *@
        @* @if (ReplayDurationMs is > 0) *@
        @* { *@
            <div class="rec-progress-row">
                <input type="range"
                       min="0"
                       max="@ReplayDurationMs"
                       value="@(_scrubPreviewMs ?? ReplayPositionMs ?? 0)"
                       class="rec-progress-slider"
                       style="@GetProgressStyle()"
                       @oninput="OnScrubPreview"
                       @onchange="OnScrubCommit" />

                <div class="rec-progress-labels">
                    <span class="rec-progress-time">
                        @FormatMs(ReplayPositionMs ?? 0)
                    </span>
                    <span class="rec-progress-time total">
                        @FormatMs(ReplayDurationMs ?? 0)
                    </span>
                </div>
            </div>
        @* } *@

        @* ── BOTTOM ROW: RECORD + REW + PLAY/PAUSE + FF + STOP ── *@
        <div class="rec-bottom-row">
            <div class="rec-transport">
                @* RECORD *@
                @if (!IsReplaying)
                {
                    if (!IsRecording)
                    {
                        <button class="cs-iconbtn rec-transport-btn"
                                title="Start recording"
                                aria-label="Start recording"
                                @onclick="StartRecording"
                                disabled="@DisableRecord">
                            ⏺
                        </button>
                    }
                    else
                    {
                        <button class="cs-iconbtn rec-transport-btn"
                                title="Stop recording"
                                aria-label="Stop recording"
                                @onclick="StopRecording">
                            ⏹
                        </button>
                    }
                }

                @* REWIND *@
                <button class="cs-iconbtn rec-transport-btn"
                        title="Rewind"
                        aria-label="Rewind"
                        @onclick="OnRewindClicked"
                        disabled="@(!IsReplaying)">
                    ⏮
                </button>

                @* PLAY / PAUSE *@
                <button class="cs-iconbtn rec-transport-btn"
                        title="@PlayButtonTitle"
                        aria-label="@PlayButtonTitle"
                        @onclick="OnPlayOrPauseClicked"
                        disabled="@PlayButtonDisabled">
                    @PlayButtonIcon
                </button>

                @* FAST FORWARD *@
                <button class="cs-iconbtn rec-transport-btn"
                        title="Fast forward"
                        aria-label="Fast forward"
                        @onclick="OnFastForwardClicked"
                        disabled="@(!IsReplaying)">
                    ⏭
                </button>

                @* STOP REPLAY *@
                <button class="cs-iconbtn rec-transport-btn"
                        title="Stop replay"
                        aria-label="Stop replay"
                        @onclick="StopReplay"
                        disabled="@(!IsReplaying)">
                    ⏹
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public bool IsRecording { get; set; }
    [Parameter] public bool IsReplaying { get; set; }
    [Parameter] public bool IsPreparingReplay { get; set; }
    [Parameter] public bool IsReplayPaused { get; set; }

    [Parameter] public string? SelectedReplayId { get; set; }
    [Parameter] public IReadOnlyList<RecordingMeta> Replays { get; set; } = Array.Empty<RecordingMeta>();
    [Parameter] public double ReplaySpeed { get; set; } = 1.0;
    [Parameter] public long? ReplayPositionMs { get; set; }
    [Parameter] public long? ReplayDurationMs { get; set; }

    [Parameter] public bool DisableRecord { get; set; }
    [Parameter] public bool DisableReplay { get; set; }

    [Parameter] public EventCallback StartRecording { get; set; }
    [Parameter] public EventCallback StopRecording { get; set; }

    [Parameter] public EventCallback StartReplay { get; set; }
    [Parameter] public EventCallback StopReplay { get; set; }

    [Parameter] public EventCallback PauseReplay { get; set; }
    [Parameter] public EventCallback ResumeReplay { get; set; }

    [Parameter] public EventCallback OnRewind { get; set; }
    [Parameter] public EventCallback OnFastForward { get; set; }

    [Parameter] public EventCallback<string> ReplaySelectionChanged { get; set; }
    [Parameter] public EventCallback<double> ReplaySpeedChanged { get; set; }

    [Parameter] public EventCallback<string> DeleteReplay { get; set; }

    [Parameter] public EventCallback<string> ExportReplay { get; set; }

    [Parameter] public EventCallback<long> SeekRequested { get; set; }

    private string _localSelectedId = "";
    private long? _scrubPreviewMs;

    protected override void OnParametersSet()
    {
        if (!string.IsNullOrWhiteSpace(SelectedReplayId) &&
            !string.Equals(SelectedReplayId, _localSelectedId, StringComparison.Ordinal))
        {
            _localSelectedId = SelectedReplayId!;
        }

        if (_scrubPreviewMs.HasValue && ReplayPositionMs.HasValue &&
            Math.Abs(_scrubPreviewMs.Value - ReplayPositionMs.Value) > 250)
        {
            _scrubPreviewMs = null;
        }
    }

    private void OnScrubPreview(ChangeEventArgs e)
    {
        if (long.TryParse(e.Value?.ToString(), out var ms))
        {
            _scrubPreviewMs = ms;
        }
    }

    private async Task OnScrubCommit(ChangeEventArgs e)
    {
        if (!SeekRequested.HasDelegate) return;

        if (long.TryParse(e.Value?.ToString(), out var ms))
        {
            _scrubPreviewMs = null;
            await SeekRequested.InvokeAsync(ms);
        }
    }

    private static string FormatMs(long ms)
    {
        if (ms <= 0) return "00:00";
        var ts = TimeSpan.FromMilliseconds(ms);
        return $"{(int)ts.TotalMinutes:00}:{ts.Seconds:00}";
    }

    private Task HandleReplayChanged(ChangeEventArgs e)
    {
        _localSelectedId = e.Value?.ToString() ?? "";
        return ReplaySelectionChanged.InvokeAsync(_localSelectedId);
    }

    private Task HandleReplaySpeedChanged(ChangeEventArgs e)
    {
        if (double.TryParse(
                e.Value?.ToString(),
                System.Globalization.NumberStyles.Float,
                System.Globalization.CultureInfo.InvariantCulture,
                out var val))
        {
            return ReplaySpeedChanged.InvokeAsync(val);
        }
        return Task.CompletedTask;
    }

    private bool IsCurrentSpeed(double value)
        => Math.Abs(ReplaySpeed - value) < 0.001;

    private static string FormatMs(long? ms)
    {
        if (ms is null || ms <= 0) return "00:00";
        var ts = TimeSpan.FromMilliseconds(ms.Value);
        return $"{(int)ts.TotalMinutes:00}:{ts.Seconds:00}";
    }

    private string GetProgressStyle()
    {
        if (ReplayDurationMs is not > 0)
            return "--cs-progress:0%;";

        long current = _scrubPreviewMs ?? ReplayPositionMs ?? 0;
        double pct = Math.Clamp(
            (double)current / ReplayDurationMs.Value,
            0.0,
            1.0
        ) * 100.0;

        return $"--cs-progress:{pct.ToString("0.##", System.Globalization.CultureInfo.InvariantCulture)}%;";
    }

    private bool PlayButtonDisabled =>
        !IsReplaying && (DisableReplay || string.IsNullOrWhiteSpace(SelectedReplayId) || IsPreparingReplay);

    private string PlayButtonTitle =>
        IsReplaying
            ? (IsReplayPaused ? "Resume replay" : "Pause replay")
            : "Play replay";

    private string PlayButtonIcon =>
        IsReplaying
            ? (IsReplayPaused ? "▶" : "⏸")
            : "▶";

    private Task OnPlayOrPauseClicked()
        => IsReplaying ? TogglePauseReplay()
                       : StartReplay.InvokeAsync();

    private Task TogglePauseReplay()
        => IsReplayPaused ? ResumeReplay.InvokeAsync()
                          : PauseReplay.InvokeAsync();

    private Task OnRewindClicked()
        => OnRewind.HasDelegate ? OnRewind.InvokeAsync() : Task.CompletedTask;

    private Task OnFastForwardClicked()
        => OnFastForward.HasDelegate ? OnFastForward.InvokeAsync() : Task.CompletedTask;

    private Task OnDeleteClicked()
    {
        if (!DeleteReplay.HasDelegate || string.IsNullOrWhiteSpace(SelectedReplayId))
            return Task.CompletedTask;

        return DeleteReplay.InvokeAsync(SelectedReplayId!);
    }

    private Task OnExportClicked()
    {
        if (!ExportReplay.HasDelegate || string.IsNullOrWhiteSpace(SelectedReplayId))
            return Task.CompletedTask;

        return ExportReplay.InvokeAsync(SelectedReplayId!);
    }
}