@page "/main"
@page "/dashboardbackup"
@using CarSpec.Models
@using CarSpec.Utils
@using CarSpec.Services.Telemetry
@inject CarSpec.Services.Obd.ObdConnectionService ObdService
@inject IJSRuntime JS
@inject CarSpec.Interfaces.IVehicleProfileService Profiles
@inject NavigationManager Nav
@inject CarSpec.Interfaces.IAppStorage Storage
@inject RecordingService Recorder
@inject ReplayService Replayer
@implements IAsyncDisposable

<div class="container">
    <h1 class="cs-title" style="font-size:26px;margin:6px 0 12px">CarSpec Dashboard</h1>

    @if (_needsSetup || Profiles?.Current == null)
    {
        <div class="cs-card warn" style="margin-bottom:12px; display:flex; align-items:center; justify-content:space-between;">
            <div>
                <strong>Vehicle setup required</strong>
                <div style="opacity:.85">Pick your car so we can save learned protocol/PIDs to its profile.</div>
            </div>
            <div>
                <button class="cs-btn primary" type="button" @onclick="RunSetup">
                    ⚙️ Run Setup
                </button>
            </div>
        </div>
    }

    <div class="cs-controls" style="justify-content:space-between;">
        <div style="display:flex;gap:16px;align-items:center;">
            <div class="cs-badge cs-badge--panel">
                <span class="label">Mode:</span>
                <span class="cs-pill @(GetModeClass())">@GetModeText()</span>
            </div>

            @if (!ObdService.IsAdapterConnected)
            {
                @if (!ObdService.IsConnecting)
                {
                    <button class="cs-btn primary" @onclick="SwitchToLive" disabled="@_needsSetup">
                        🔌 Connect to OBD
                    </button>
                }
                else
                {
                    <button class="cs-btn btn-secondary" @onclick="CancelConnecting" disabled="@_needsSetup">
                        ⛔ Stop Connecting
                    </button>
                }
            }
            else if (ObdService.IsAdapterConnected && !ObdService.IsEcuConnected)
            {
                <button class="cs-btn btn-secondary" @onclick="ReconnectEcu" disabled="@_needsSetup">
                    🔁 Reconnect ECU
                </button>
                <button class="cs-btn btn-secondary" @onclick="Disconnect" disabled="@_needsSetup">
                    🔌 Disconnect OBD
                </button>
            }
            else if (ObdService.IsEcuConnected)
            {
                <button class="cs-btn btn-secondary" @onclick="Disconnect" disabled="@_needsSetup">
                    🔌 Disconnect OBD
                </button>
            }
        </div>

        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px">
            @* RECORDING *@
            @if (!_isReplaying)
            {
                @if (!_isRecording)
                {
                    <button class="cs-btn" @onclick="StartRecording" disabled="@_needsSetup || !ObdService.IsEcuConnected">
                        ⏺️ Start Recording
                    </button>
                }
                else
                {
                    <button class="cs-btn btn-secondary" @onclick="StopRecording">
                        ⏹️ Stop Recording
                    </button>
                }
            }

            @* REPLAY *@
            <div class="cs-badge cs-badge--panel" style="gap:8px">
                <span class="label">Replay:</span>

                <select class="cs-input" style="min-width:220px"
                        value="@_selectedReplayId"
                        @onchange="OnReplayChanged">
                    <option value="">(none)</option>
                    @foreach (var r in _replays)
                    {
                        <option value="@r.Id">@($"{(r.Vehicle ?? "Unknown")} — {FormatMs(r.DurationMs)} — {r.CreatedUtc.ToLocalTime():g}")</option>
                    }
                </select>

                @if (!_isReplaying)
                {
                    <button class="cs-btn" @onclick="StartReplay" disabled="@string.IsNullOrWhiteSpace(_selectedReplayId)">
                        ▶️ Play
                    </button>
                }
                else
                {
                    <button class="cs-btn btn-secondary" @onclick="StopReplay">⏹️ Stop</button>
                }

                <label style="margin-left:8px;opacity:.8">Speed</label>
                <select class="cs-input" style="width:90px" @onchange="OnReplaySpeedChanged">
                    <option value="0.5">0.5×</option>
                    <option value="1">1×</option>
                    <option value="1.5">1.5×</option>
                    <option value="2">2×</option>
                    <option value="3">3×</option>
                </select>
            </div>
        </div>

        <div class="cs-seg-icons" role="tablist" aria-label="Display mode">
            <button class="seg @( _view == DisplayMode.Gauges ? "active" : null )"
                    @onclick="() => SwitchView(DisplayMode.Gauges)"
                    title="Gauges" aria-pressed="@(_view == DisplayMode.Gauges)">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 3a9 9 0 0 0-9 9h2a7 7 0 1 1 14 0h2a9 9 0 0 0-9-9z"
                          fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                    <path d="M12 13l4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    <circle cx="12" cy="13" r="1.6" fill="currentColor" />
                </svg>
            </button>

            <button class="seg @( _view == DisplayMode.Numbers ? "active" : null )"
                    @onclick="() => SwitchView(DisplayMode.Numbers)"
                    title="Numbers" aria-pressed="@(_view == DisplayMode.Numbers)">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 8h16M4 16h16M8 4v16M16 4v16"
                          fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
                </svg>
            </button>
        </div>
    </div>

    @if (ObdService.IsEcuConnected)
    {
            var fp = ObdService.LastFingerprint;
            var protoDisplay = string.IsNullOrWhiteSpace(fp?.Protocol)
                ? (Profiles?.Current?.ProtocolDetected ?? "—")
                : (fp!.Protocol);
            var vinDisplay = string.IsNullOrWhiteSpace(fp?.Vin) ? $"—  (Profile Id: {Profiles?.Current?.Id ?? "—"})" : fp!.Vin;
            var pidCount = fp?.SupportedPids?.Count
                ?? (Profiles?.Current?.SupportedPidsCache?.Count ?? (int?)null);
        <section class="cs-card" style="margin:12px 0">
            <h3>ECU ID</h3>
            <div>VIN: <strong>@vinDisplay</strong></div>
            <div>Protocol: <strong>@(string.IsNullOrWhiteSpace(protoDisplay) ? "—" : protoDisplay)</strong></div>
            <div>Year (from VIN): <strong>@(fp?.Year?.ToString() ?? (Profiles?.Current?.YearDetected?.ToString() ?? "—"))</strong></div>
            <div>Supported PIDs: <strong>@(pidCount?.ToString() ?? "—")</strong></div>
        </section>
    }

    @if (carData is null)
    {
        <p>Waiting for data...</p>
    }
    else
    {
        @if (ObdService.IsEcuConnected && _planKnown)
        {
            <div class="cs-grid @( _view == DisplayMode.Gauges ? "" : "is-hidden")" style="margin-bottom:18px">
                @if (CanShow(PID_RPM))
                {
                    <section class="cs-card">
                        <h3>RPM</h3>
                        <div class="gauge-host"><canvas id="rpmGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_SPEED))
                {
                    <section class="cs-card">
                        <h3>Speed</h3>
                        <div class="gauge-host"><canvas id="speedGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_TPS))
                {
                    <section class="cs-card">
                        <h3>Throttle</h3>
                        <div class="gauge-host"><canvas id="throttleGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_FUEL))
                {
                    <section class="cs-card">
                        <h3>Fuel</h3>
                        <div class="gauge-host"><canvas id="fuelGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_COOLANT))
                {
                    <section class="cs-card">
                        <h3>Coolant</h3>
                        <div class="gauge-host"><canvas id="coolantGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_OIL))
                {
                    <section class="cs-card">
                        <h3>Oil Temp</h3>
                        <div class="gauge-host"><canvas id="oilGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_IAT))
                {
                    <section class="cs-card">
                        <h3>Intake Air</h3>
                        <div class="gauge-host"><canvas id="iatGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_LOAD))
                {
                    <section class="cs-card">
                        <h3>Engine Load</h3>
                        <div class="gauge-host"><canvas id="loadGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_FPRESS))
                {
                    <section class="cs-card">
                        <h3>Fuel Pressure</h3>
                        <div class="gauge-host"><canvas id="fpGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_MAP))
                {
                    <section class="cs-card">
                        <h3>MAP</h3>
                        <div class="gauge-host"><canvas id="mapGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_TADV))
                {
                    <section class="cs-card">
                        <h3>Timing Advance</h3>
                        <div class="gauge-host"><canvas id="tadvGauge"></canvas></div>
                    </section>
                }
                @if (CanShow(PID_MAF))
                {
                    <section class="cs-card">
                        <h3>MAF</h3>
                        <div class="gauge-host"><canvas id="mafGauge"></canvas></div>
                    </section>
                }
            </div>

            <div class="cs-grid @( _view == DisplayMode.Numbers ? "" : "is-hidden")" style="margin-bottom:18px">
                @if (CanShow(PID_RPM))
                {
                    <section class="cs-card cs-metric">
                        <h3>RPM</h3>
                        <div class="metric @RpmClass(carData?.RPM)"><span class="value">@FormatInt(carData?.RPM)</span><span class="unit">rpm</span></div>
                    </section>
                }
                @if (CanShow(PID_SPEED))
                {
                    <section class="cs-card cs-metric">
                        <h3>Speed</h3>
                        <div class="metric @SpeedClass(carData?.Speed)"><span class="value">@FormatInt(carData?.Speed)</span><span class="unit">mph</span></div>
                    </section>
                }
                @if (CanShow(PID_TPS))
                {
                    <section class="cs-card cs-metric">
                        <h3>Throttle</h3>
                        <div class="metric @ThrottleClass(carData?.ThrottlePercent)"><span class="value">@FormatInt(carData?.ThrottlePercent)</span><span class="unit">%</span></div>
                    </section>
                }
                @if (CanShow(PID_FUEL))
                {
                    <section class="cs-card cs-metric">
                        <h3>Fuel</h3>
                        <div class="metric @FuelClass(carData?.FuelLevelPercent)"><span class="value">@FormatInt(carData?.FuelLevelPercent)</span><span class="unit">%</span></div>
                    </section>
                }
                @if (CanShow(PID_COOLANT))
                {
                    <section class="cs-card cs-metric">
                        <h3>Coolant</h3>
                        <div class="metric @TempClass(carData?.CoolantTempF)"><span class="value">@FormatInt(carData?.CoolantTempF)</span><span class="unit">°F</span></div>
                    </section>
                }
                @if (CanShow(PID_OIL))
                {
                    <section class="cs-card cs-metric">
                        <h3>Oil Temp</h3>
                        <div class="metric @TempClass(carData?.OilTempF)"><span class="value">@FormatInt(carData?.OilTempF)</span><span class="unit">°F</span></div>
                    </section>
                }
                @if (CanShow(PID_IAT))
                {
                    <section class="cs-card cs-metric">
                        <h3>Intake Air</h3>
                        <div class="metric @IatClass(carData?.IntakeTempF)"><span class="value">@FormatInt(carData?.IntakeTempF)</span><span class="unit">°F</span></div>
                    </section>
                }
                @if (CanShow(PID_LOAD))
                {
                    <section class="cs-card cs-metric">
                        <h3>Engine Load</h3>
                        <div class="metric"><span class="value">@FormatInt(carData?.EngineLoadPercent)</span><span class="unit">%</span></div>
                    </section>
                }
                @if (CanShow(PID_FPRESS))
                {
                    <section class="cs-card cs-metric">
                        <h3>Fuel Pressure</h3>
                        <div class="metric"><span class="value">@FormatInt(carData?.FuelPressureKpa)</span><span class="unit">kPa</span></div>
                    </section>
                }
                @if (CanShow(PID_MAP))
                {
                    <section class="cs-card cs-metric">
                        <h3>MAP</h3>
                        <div class="metric"><span class="value">@FormatInt(carData?.MapKpa)</span><span class="unit">kPa</span></div>
                    </section>
                }
                @if (CanShow(PID_TADV))
                {
                    <section class="cs-card cs-metric">
                        <h3>Timing</h3>
                        <div class="metric"><span class="value">@FormatInt(carData?.TimingAdvanceDeg)</span><span class="unit">°</span></div>
                    </section>
                }
                @if (CanShow(PID_MAF))
                {
                    <section class="cs-card cs-metric">
                        <h3>MAF</h3>
                        <div class="metric"><span class="value">@FormatInt(carData?.MafGramsPerSec)</span><span class="unit">g/s</span></div>
                    </section>
                }
                @if (CanShow(PID_BARO))
                {
                    <section class="cs-card cs-metric">
                        <h3>Barometric Pressure</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.BaroKPa)</span><span class="unit">kPa</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_FRP_REL))
                {
                    <section class="cs-card cs-metric">
                        <h3>Fuel Rail (relative)</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.FuelRailPressureRelKPa)</span><span class="unit">kPa</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_FRP_GAUGE))
                {
                    <section class="cs-card cs-metric">
                        <h3>Fuel Rail (gauge)</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.FuelRailGaugePressureKPa)</span><span class="unit">kPa</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_EGR_CMD))
                {
                    <section class="cs-card cs-metric">
                        <h3>Commanded EGR</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.CommandedEgrPercent)</span><span class="unit">%</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_EGR_ERR))
                {
                    <section class="cs-card cs-metric">
                        <h3>EGR Error</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.EgrErrorPercent)</span><span class="unit">%</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_EVAP_CMD))
                {
                    <section class="cs-card cs-metric">
                        <h3>Cmd EVAP Purge</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.CommandedEvapPurgePercent)</span><span class="unit">%</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_EVAP_P))
                {
                    <section class="cs-card cs-metric">
                        <h3>EVAP Vapor Pressure</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.EvapVaporPressurePa)</span><span class="unit">Pa</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_WARMUPS))
                {
                    <section class="cs-card cs-metric">
                        <h3>Warm-ups (since clear)</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.WarmUpsSinceClear)</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_DIST_MIL))
                {
                    <section class="cs-card cs-metric">
                        <h3>Distance w/ MIL</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.DistanceWithMilKm)</span><span class="unit">km</span>
                        </div>
                    </section>
                }

                @if (CanShow(PID_DIST_CLR))
                {
                    <section class="cs-card cs-metric">
                        <h3>Distance since clear</h3>
                        <div class="metric">
                            <span class="value">@FormatInt(carData?.DistanceSinceClearKm)</span><span class="unit">km</span>
                        </div>
                    </section>
                }
            </div>
        }
        else if (ObdService.IsEcuConnected && !_planKnown)
        {
            <div class="cs-card info" style="margin-bottom:12px">
                Detecting supported sensors for this vehicle…
            </div>
        }

        <section class="cs-card full">
            <div class="cs-card__header">
                <h3>Log</h3>
                <button class="cs-btn btn-secondary cs-btn--sm" type="button"
                        @onclick="ClearLog" disabled="@(outputLog.Count == 0)">
                    Clear Log
                </button>
            </div>

            <pre class="cs-log__pre">
        @string.Join("\n", outputLog.TakeLast(120))
            </pre>
        </section>
    }
</div>

@code {
    private CarData? carData;
    private readonly List<string> outputLog = new();
    private CancellationTokenSource? _simCts;
    private readonly TimeSpan _simTick = TimeSpan.FromSeconds(1);
    private enum DisplayMode { Gauges, Numbers }
    private DisplayMode _view = DisplayMode.Gauges;
    private bool _needsSetup;
    private bool _attachInProgress;
    private Action<EcuFingerprint?>? _fpHandler;
    private Action? _stateHandler;
    private Task _pendingAttach = Task.CompletedTask;
    private bool _isRecording;
    private string? _currentRecordingId;
    private List<RecordingMeta> _replays = new();
    private string _selectedReplayId = "";
    private bool _isReplaying;
    private double _replaySpeed = 1.0;

    private IJSObjectReference? gaugeModule;
    private bool gaugeReady;

    private void RunSetup() => Nav.NavigateTo("/setup");

    // --- PID-aware UI state ---
    private HashSet<string> _plan = new(StringComparer.OrdinalIgnoreCase);
    private bool _planKnown => _plan.Count > 0;
    private bool CanShow(string pid) => _plan.Contains(pid);

    // PID constants
    private const string PID_RPM = "010C";
    private const string PID_SPEED = "010D";
    private const string PID_TPS = "0111";
    private const string PID_FUEL = "012F";
    private const string PID_COOLANT = "0105";
    private const string PID_IAT = "010F";
    private const string PID_OIL = "015C";
    private const string PID_LOAD = "0104";
    private const string PID_FPRESS = "010A";
    private const string PID_MAP = "010B";
    private const string PID_TADV = "010E";
    private const string PID_MAF = "0110";
    private const string PID_DIST_MIL = "0121";
    private const string PID_FRP_REL = "0122";
    private const string PID_FRP_GAUGE = "0123";
    private const string PID_EGR_CMD = "012C";
    private const string PID_EGR_ERR = "012D";
    private const string PID_EVAP_CMD = "012E";
    private const string PID_WARMUPS = "0130";
    private const string PID_DIST_CLR = "0131";
    private const string PID_EVAP_P = "0132";
    private const string PID_BARO = "0133";

    private string ProfileKey(VehicleProfile? v) => v is null ? "" : $"{v.Year}|{v.Make}|{v.Model}";
    private string _lastProfileKey = "";

    private int GetTachMax() => Profiles?.Current?.TachMaxRpm ?? 9000;
    private int GetRedlineStart() => Profiles?.Current?.TachRedlineStart ?? 7000;
    private int GetSpeedMax() => Profiles?.Current?.SpeedMaxMph ?? 160;

    private string[] BuildTachMajorTicks(int tachMax)
    {
        var steps = Math.Max(1, tachMax / 1000);
        var labels = new List<string>(steps + 1);
        for (int k = 0; k <= steps; k++) labels.Add(k.ToString());
        return labels.ToArray();
    }

    private string[] BuildSpeedMajorTicks(int speedMax)
    {
        var labels = new List<string>();
        for (int s = 0; s <= speedMax; s += 20) labels.Add(s.ToString());
        return labels.ToArray();
    }

    protected override async Task OnInitializedAsync()
    {
        // seed log + subscribe
        try { outputLog.AddRange(ObdService.GetLogSnapshot()); } catch { }
        ObdService.OnLog += HandleLog;

        _fpHandler = _ => InvokeAsync(StateHasChanged);
        ObdService.OnFingerprint += _fpHandler;

        _stateHandler = () => _ = OnServiceStateChangedAsync();
        ObdService.OnStateChanged += _stateHandler;

        ObdService.OnData += HandleLiveData;

        Log("🚀 CarSpec Dashboard Successfully Started...");

        await RecomputeNeedsSetupAsync();
        _lastProfileKey = ProfileKey(Profiles?.Current);

        // seed gauges from last live snapshot (snappy return after navigation)
        try { carData = ObdService.LastSnapshot ?? await ObdService.GetLatestDataAsync(); } catch { }
        try { _replays = await Recorder.ListAsync(); } catch { _replays = new(); }

        if (!_needsSetup && ObdService.IsEcuConnected && !ObdService.SimulationMode)
            await AttachLiveStreamAsync();
        else
            StartSimulationLoop();
    }

    private async Task RecomputeNeedsSetupAsync()
    {
        // What storage says
        var hasVehicleKey = await Storage.HasAsync(AppKeys.VehicleProfile);
        var hasCompleted  = await Storage.HasAsync(AppKeys.SetupCompleted);

        // What the profile service *actually* has
        try { await Profiles.LoadAsync(); } catch { /* ignore */ }
        var hasCurrentProfile = Profiles?.Current != null;

        // We require *both* a current profile and the setup-completed marker
        _needsSetup = !hasCurrentProfile || !hasVehicleKey || !hasCompleted;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await EnsureGaugesInitializedAsync();

            if (ObdService.IsEcuConnected && !ObdService.SimulationMode)
                await AttachLiveStreamAsync();
        }
    }

    private async Task OnServiceStateChangedAsync()
    {
        // Re-render the mode pill immediately
        await InvokeAsync(StateHasChanged);

        // If ECU just came online, make sure gauges attach/init without page hop
        if (ObdService.IsEcuConnected && !ObdService.SimulationMode && !_attachInProgress)
        {
            // Avoid overlapping attach calls
            if (_pendingAttach.IsCompleted)
                _pendingAttach = AttachLiveStreamAsync();
        }
    }

    private async void HandleLiveData(CarData cd)
    {
        if (_isRecording)
        {
            try { await Recorder.AppendAsync(cd); } catch { }
        }

        var newPlan = (ObdService.CurrentPollPlan ?? Array.Empty<string>())
                      .ToHashSet(StringComparer.OrdinalIgnoreCase);
        bool planChanged = !_planKnown || !_plan.SetEquals(newPlan);

        await InvokeAsync(async () =>
        {
            carData = cd;

            if (planChanged)
            {
                _plan = newPlan;
                if (_view == DisplayMode.Gauges)
                {
                    gaugeReady = false;
                    StateHasChanged();
                    await Task.Yield();
                    await EnsureGaugesInitializedAsync();
                }
            }

            await SafeSetAllGaugesAsync();
            StateHasChanged();
        });
    }

    private async Task StartRecording()
    {
        if (_isReplaying) return; // don’t record during replay

        // If not live, bail (you could allow sim, but you said record while running)
        if (!ObdService.IsEcuConnected || ObdService.SimulationMode)
        {
            Log("⚠️ Cannot start recording — ECU not live.");
            return;
        }

        try
        {
            var id = await Recorder.StartAsync(Profiles?.Current, ObdService.LastFingerprint, note: null);
            _currentRecordingId = id;
            _isRecording = true;
            Log($"⏺️ Recording started (id={id}).");
        }
        catch (Exception ex)
        {
            Log($"❌ Failed to start recording: {ex.Message}");
        }
    }

    private async Task StopRecording()
    {
        if (!_isRecording) return;
        try
        {
            var meta = await Recorder.StopAsync(gzip: true);
            _isRecording = false;
            Log($"⏹️ Recording saved ({meta?.Frames ?? 0} frames, {FormatMs(meta?.DurationMs)})");
            _replays = await Recorder.ListAsync();
            if (!string.IsNullOrWhiteSpace(meta?.Id))
                _selectedReplayId = meta!.Id; // preselect the one we just made
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Log($"❌ Failed to stop/save recording: {ex.Message}");
            _isRecording = false;
        }
    }

    private async Task OnReplayChanged(ChangeEventArgs e)
    {
        _selectedReplayId = e?.Value?.ToString() ?? "";
        await OnReplaySelectionChanged(); // <- keep this as a PARAMETERLESS helper, or inline the logic here
    }

    private Task OnReplaySelectionChanged()
    {
        // do whatever you need after selection changes (load metadata, enable Play button, etc.)
        return Task.CompletedTask;
    }

    private async Task StartReplay()
    {
        if (string.IsNullOrWhiteSpace(_selectedReplayId)) return;

        // Ensure we’re not recording and not connected
        if (_isRecording) await StopRecording();

        await ObdService.Disconnect();
        ObdService.SimulationMode = true; // make sure live loop won’t fight replay

        _isReplaying = true;
        double speed = _replaySpeed <= 0 ? 1.0 : _replaySpeed;

        Log($"▶️ Starting replay {_selectedReplayId} at {speed:0.##}×");

        // Seed gauges quickly with zeros (optional)
        await ZeroOutDataAsync();

        // Pump frames into dashboard just like live
        await Replayer.StartAsync(
            _selectedReplayId,
            onFrame: async cd =>
            {
                await InvokeAsync(async () =>
                {
                    carData = cd;
                    // No plan from replay; show everything you recorded:
                    if (_view == DisplayMode.Gauges && !gaugeReady)
                        await EnsureGaugesInitializedAsync();

                    await SafeSetAllGaugesAsync();
                    StateHasChanged();
                });
            },
            onStop: () =>
            {
                _isReplaying = false;
                Log("⏹️ Replay finished.");
                InvokeAsync(StateHasChanged);
            },
            speed: speed
        );
    }

    private Task StopReplay()
    {
        if (!_isReplaying) return Task.CompletedTask;
        Replayer.Stop();
        _isReplaying = false;
        Log("⏹️ Replay stopped.");
        return Task.CompletedTask;
    }

    private Task OnReplaySpeedChanged(ChangeEventArgs e)
    {
        if (double.TryParse(e?.Value?.ToString(), System.Globalization.NumberStyles.Float,
                            System.Globalization.CultureInfo.InvariantCulture, out var x))
            _replaySpeed = x;
        return Task.CompletedTask;
    }

    private async Task EnsureGaugesInitializedAsync()
    {
        if (gaugeReady || _view != DisplayMode.Gauges) return;

        gaugeModule ??= await JS.InvokeAsync<IJSObjectReference>("import", "./js/carspec.gauges.js");

        if (CanShow(PID_RPM))
        {
            var tachMax  = GetTachMax();
            var redStart = GetRedlineStart();
            var ticks    = BuildTachMajorTicks(tachMax);
            await gaugeModule.InvokeVoidAsync("initGauge", "rpmGauge", new {
                type = "radial", value = carData?.RPM ?? 0, minValue = 0, maxValue = tachMax,
                startAngle = 46, ticksAngle = 270, units = "rpm",
                majorTicks = ticks, minorTicks = 5,
                highlights = new[] { new { from = redStart, to = tachMax, color = "rgba(255,0,0,.28)" } },
                noResize = true
            });
        }

        if (CanShow(PID_SPEED))
        {
            var speedMax  = GetSpeedMax();
            var speedTicks = BuildSpeedMajorTicks(speedMax);
            await gaugeModule.InvokeVoidAsync("initGauge", "speedGauge", new {
                type = "radial", value = carData?.Speed ?? 0, minValue = 0, maxValue = speedMax,
                units = "mph", majorTicks = speedTicks, minorTicks = 2, highlights = Array.Empty<object>()
            });
        }

        if (CanShow(PID_TPS))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "throttleGauge", new {
                type = "linear", value = carData?.ThrottlePercent ?? 0,
                minValue = 0, maxValue = 100, valueSuffix = "%", linearOverrides = new { needleSide = "right" }
            });
        }

        if (CanShow(PID_FUEL))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "fuelGauge", new {
                type = "linear", value = carData?.FuelLevelPercent ?? 0,
                minValue = 0, maxValue = 100, valueSuffix = "%", linearOverrides = new { needleSide = "right" }
            });
        }

        if (CanShow(PID_COOLANT))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "coolantGauge", new {
                type = "radial", value = carData?.CoolantTempF ?? 0,
                minValue = 120, maxValue = 260, units = "°F",
                majorTicks = new[] { "120", "160", "180", "200", "220", "240", "260" }
            });
        }

        if (CanShow(PID_OIL))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "oilGauge", new {
                type = "radial", value = carData?.OilTempF ?? 0,
                minValue = 120, maxValue = 300, units = "°F",
                majorTicks = new[] { "120", "160", "180", "200", "220", "240", "260", "280", "300" }
            });
        }

        if (CanShow(PID_IAT))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "iatGauge", new {
                type = "radial", value = carData?.IntakeTempF ?? 0,
                minValue = 0, maxValue = 200, units = "°F",
                majorTicks = new[] { "0", "50", "100", "150", "200" }
            });
        }

        if (CanShow(PID_LOAD))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "loadGauge", new {
                type = "linear", value = carData?.EngineLoadPercent ?? 0,
                minValue = 0, maxValue = 100, valueSuffix = "%", 
                linearOverrides = new { needleSide = "right" }
            });
        }

        if (CanShow(PID_FPRESS))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "fpGauge", new {
                type = "radial", value = carData?.FuelPressureKpa ?? 0,
                minValue = 0, maxValue = 700, units = "kPa",   // ~70 psi
                majorTicks = new[] { "0","100","200","300","400","500","600","700" }
            });
        }

        if (CanShow(PID_MAP))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "mapGauge", new {
                type = "radial", value = carData?.MapKpa ?? 0,
                minValue = 0, maxValue = 255, units = "kPa",
                majorTicks = new[] { "0","50","100","150","200","250" }
            });
        }

        if (CanShow(PID_TADV))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "tadvGauge", new {
                type = "radial", value = carData?.TimingAdvanceDeg ?? 0,
                minValue = -64, maxValue = 63.5, units = "°",
                majorTicks = new[] { "-60","-30","0","30","60" }
            });
        }

        if (CanShow(PID_MAF))
        {
            await gaugeModule.InvokeVoidAsync("initGauge", "mafGauge", new {
                type = "radial", value = carData?.MafGramsPerSec ?? 0,
                minValue = 0, maxValue = 300, units = "g/s",
                majorTicks = new[] { "0","50","100","150","200","250","300" }
            });
        }

        gaugeReady = true;
    }

    private async Task ReinitProfileScaledGaugesAsync()
    {
        if (gaugeModule is null) return;

        try { await gaugeModule.InvokeVoidAsync("dispose", "rpmGauge"); } catch { }
        try { await gaugeModule.InvokeVoidAsync("dispose", "speedGauge"); } catch { }

        var tachMax = GetTachMax();
        var redStart = GetRedlineStart();
        var tachTicks = BuildTachMajorTicks(tachMax);

        await gaugeModule.InvokeVoidAsync("initGauge", "rpmGauge", new {
            type = "radial", value = carData?.RPM ?? 0, minValue = 0, maxValue = tachMax,
            startAngle = 46, ticksAngle = 270, units = "rpm",
            majorTicks = tachTicks, minorTicks = 5,
            highlights = new[] { new { from = redStart, to = tachMax, color = "rgba(255,0,0,.28)" } },
            noResize = true
        });

        var speedMax = GetSpeedMax();
        var speedTicks = BuildSpeedMajorTicks(speedMax);

        await gaugeModule.InvokeVoidAsync("initGauge", "speedGauge", new {
            type = "radial", value = carData?.Speed ?? 0, minValue = 0, maxValue = speedMax,
            units = "mph", majorTicks = speedTicks, minorTicks = 2, highlights = Array.Empty<object>()
        });
    }

    protected override async Task OnParametersSetAsync()
    {
        await RecomputeNeedsSetupAsync();

        // If profiles were deleted while connected, fall back to sim and stop polling
        if (_needsSetup && ObdService.IsEcuConnected)
        {
            await ObdService.Disconnect();
            ObdService.SimulationMode = true;
        }

        var key = ProfileKey(Profiles?.Current);
        if (key != _lastProfileKey && gaugeReady)
        {
            _lastProfileKey = key;
            await ReinitProfileScaledGaugesAsync();
            StateHasChanged();
        }
    }

    private async Task SwitchView(DisplayMode v)
    {
        _view = v;
        StateHasChanged();

        if (v == DisplayMode.Gauges)
        {
            if (!gaugeReady) await EnsureGaugesInitializedAsync();
            await Task.Delay(30);
            if (gaugeModule is not null) await gaugeModule.InvokeVoidAsync("refreshOnShow");
        }
    }

    private async Task SafeSetAllGaugesAsync()
    {
        if (_view != DisplayMode.Gauges || !gaugeReady || gaugeModule is null) return;

        var fast = new { durSmall = 90, durMed = 160, durBig = 260, durMax = 320 };
        var med  = new { durSmall = 120, durMed = 220, durBig = 360, durMax = 420 };
        var slow = new { durSmall = 160, durMed = 260, durBig = 420, durMax = 480 };

        async Task SetIf(string id, double? value, object opts)
        {
            try { await gaugeModule.InvokeVoidAsync("setSmooth", id, value ?? 0, opts); } catch { }
        }

        if (CanShow(PID_RPM))     await SetIf("rpmGauge",      carData?.RPM,             fast);
        if (CanShow(PID_TPS))     await SetIf("throttleGauge", carData?.ThrottlePercent, fast);
        if (CanShow(PID_SPEED))   await SetIf("speedGauge",    carData?.Speed,           fast);
        if (CanShow(PID_LOAD))    await SetIf("loadGauge",  carData?.EngineLoadPercent, fast);
        if (CanShow(PID_IAT))     await SetIf("iatGauge",      carData?.IntakeTempF,     med);
        if (CanShow(PID_COOLANT)) await SetIf("coolantGauge",  carData?.CoolantTempF,    med);
        if (CanShow(PID_FPRESS))  await SetIf("fpGauge",    carData?.FuelPressureKpa,    med);
        if (CanShow(PID_MAP))     await SetIf("mapGauge",   carData?.MapKpa,             med);
        if (CanShow(PID_TADV))    await SetIf("tadvGauge",  carData?.TimingAdvanceDeg,   med);
        if (CanShow(PID_FUEL))    await SetIf("fuelGauge",     carData?.FuelLevelPercent, slow);
        if (CanShow(PID_OIL))     await SetIf("oilGauge",      carData?.OilTempF,         slow);
        if (CanShow(PID_MAF))     await SetIf("mafGauge",   carData?.MafGramsPerSec,     slow);
    }

    private static string FormatInt(int? n) => n is null ? "—" : n.Value.ToString();
    private static string FormatInt(double? n) => n is null ? "—" : Math.Round(n.Value).ToString("0");

    private string RpmClass(double? r)
    {
        if (r is null) return "";
        var red = GetRedlineStart();
        var warn = (int)(red * 0.8);
        return r >= red ? "bad" : r >= warn ? "warn" : "good";
    }
    private static string SpeedClass(double? s) => s is null ? "" : (s >= 120 ? "bad" : s >= 90 ? "warn" : "good");
    private static string ThrottleClass(double? t) => t is null ? "" : (t >= 90 ? "bad" : t >= 70 ? "warn" : "good");
    private static string FuelClass(double? f) => f is null ? "" : (f <= 10 ? "bad" : f <= 25 ? "warn" : "good");
    private static string TempClass(double? f) => f is null ? "" : (f >= 230 ? "bad" : f >= 215 ? "warn" : "good");
    private static string IatClass(double? f) => f is null ? "" : (f >= 150 ? "bad" : f >= 120 ? "warn" : "good");

    private void StartSimulationLoop()
    {
        _simCts?.Cancel();
        _simCts = new CancellationTokenSource();
        var token = _simCts.Token;

        _ = Task.Run(async () =>
        {
            while (!token.IsCancellationRequested)
            {
                try
                {
                    if (ObdService.SimulationMode)
                    {
                        carData = CarData.Simulated();
                        await InvokeAsync(async () =>
                        {
                            await SafeSetAllGaugesAsync();
                            StateHasChanged();
                        });
                    }
                }
                catch { }
                try { await Task.Delay(_simTick, token); } catch { }
            }
        }, token);
    }

    private async Task SwitchToLive()
    {
        if (_needsSetup) { Nav.NavigateTo("/setup"); return; }

        Log("🔌 Attempting to connect to Live OBD-II...");
        bool connected = await ObdService.AutoConnectAsync();
        if (connected)
        {
            Log("✅ Connected to OBD-II adapter successfully!");
            await ZeroOutDataAsync();

            if (!ObdService.SimulationMode && ObdService.IsEcuConnected)
            {
                Log("📡 Starting live ECU data stream...");
                _ = ObdService.StartLiveDataLoopAsync(async cd =>
                {
                    var newPlan = (ObdService.CurrentPollPlan ?? Array.Empty<string>())
                                  .ToHashSet(StringComparer.OrdinalIgnoreCase);
                    bool planChanged = !_planKnown || !_plan.SetEquals(newPlan);

                    await InvokeAsync(async () =>
                    {
                        carData = cd;

                        if (planChanged)
                        {
                            _plan = newPlan;
                            gaugeReady = false;
                            StateHasChanged();
                            await Task.Yield();
                            await EnsureGaugesInitializedAsync();
                        }

                        await SafeSetAllGaugesAsync();
                        StateHasChanged();
                    });
                });
            }
            else
            {
                Log("⚠️ ECU not responding — staying in Simulation Mode.");
            }
        }

        await InvokeAsync(StateHasChanged);
    }

    private async Task ReconnectEcu()
    {
        if (await ObdService.TryReconnectEcuAsync())
        {
            Log("✅ ECU is now online!");
            await ZeroOutDataAsync();

            if (!ObdService.SimulationMode && ObdService.IsEcuConnected)
            {
                Log("📡 Resuming live ECU data stream...");
                _ = ObdService.StartLiveDataLoopAsync(async cd =>
                {
                    await InvokeAsync(async () =>
                    {
                        carData = cd;
                        await SafeSetAllGaugesAsync();
                        StateHasChanged();
                    });
                });
            }
        }
        else
        {
            Log("❌ ECU still offline.");
        }
    }

    private async Task AttachLiveStreamAsync()
    {
        if (_attachInProgress) return;
        _attachInProgress = true;
        try
        {
            if (ObdService.IsEcuConnected && !ObdService.SimulationMode)
            {
                _plan = (ObdService.CurrentPollPlan ?? Array.Empty<string>())
                        .ToHashSet(StringComparer.OrdinalIgnoreCase);

                carData = ObdService.LastSnapshot;   // seed last values immediately

                if (_view == DisplayMode.Gauges)
                {
                    gaugeReady = false;
                    await EnsureGaugesInitializedAsync();
                    await SafeSetAllGaugesAsync();
                }

                _ = ObdService.StartLiveDataLoopAsync(async cd =>
                {
                    var newPlan = (ObdService.CurrentPollPlan ?? Array.Empty<string>())
                                  .ToHashSet(StringComparer.OrdinalIgnoreCase);
                    bool planChanged = !_planKnown || !_plan.SetEquals(newPlan);

                    await InvokeAsync(async () =>
                    {
                        carData = cd;

                        if (planChanged)
                        {
                            _plan = newPlan;
                            gaugeReady = false;
                            StateHasChanged();
                            await Task.Yield();
                            await EnsureGaugesInitializedAsync();
                        }

                        await SafeSetAllGaugesAsync();
                        StateHasChanged();
                    });
                });
            }
        }
        finally { _attachInProgress = false; }
    }

    private Task CancelConnecting()
    {
        ObdService.CancelConnection();
        return Task.CompletedTask;
    }

    private async Task Disconnect()
    {
        await ObdService.Disconnect();
        await InvokeAsync(StateHasChanged);
        ObdService.SimulationMode = true;
    }

    private void HandleLog(string message)
    {
        outputLog.Add($"[{DateTime.Now:T}] {message}");
        if (outputLog.Count > 500) outputLog.RemoveAt(0);
        InvokeAsync(StateHasChanged);
    }

    private void Log(string message) => HandleLog(message);

    private string GetModeText() =>
        ObdService.IsConnecting
            ? (ObdService.IsCancelRequested ? "Canceling…" : "Connecting…")
            : (ObdService.IsEcuConnected ? "Live ECU Connected"
               : (ObdService.IsAdapterConnected ? "Adapter Connected (ECU Offline)"
                  : ObdService.SimulationMode ? "Simulation Mode" : "Disconnected"));

    private string GetModeClass() =>
        ObdService.IsConnecting ? "is-connecting" :
        ObdService.IsEcuConnected ? "is-live" :
        (ObdService.IsAdapterConnected ? "is-adapter" :
        ObdService.SimulationMode ? "is-sim" : "is-disc");

    private async Task ZeroOutDataAsync()
    {
        carData ??= new CarData();
        carData.RPM = 0;
        carData.Speed = 0;
        carData.ThrottlePercent = 0;
        carData.FuelLevelPercent = 0;
        carData.CoolantTempF = 0;
        carData.OilTempF = 0;
        carData.IntakeTempF = 0;
        carData.LastUpdated = DateTime.Now;

        await SafeSetAllGaugesAsync();
        await InvokeAsync(StateHasChanged);
    }

    public async ValueTask DisposeAsync()
    {
        _simCts?.Cancel();
        _simCts = null;

        if (gaugeModule is not null)
        {
            try { await gaugeModule.InvokeVoidAsync("disposeAll"); } catch { }
            await gaugeModule.DisposeAsync();
        }

        ObdService.OnLog -= HandleLog;
        ObdService.OnData -= HandleLiveData;
        if (_fpHandler is not null) ObdService.OnFingerprint -= _fpHandler;
        if (_stateHandler is not null) ObdService.OnStateChanged -= _stateHandler;

        Replayer.Stop();
        if (_isRecording) try { await Recorder.StopAsync(); } catch { }
    }

    public void ClearLog()
    {
        outputLog.Clear();
        StateHasChanged();
    }

    private static string FormatMs(long? ms)
    {
        if (ms is null || ms <= 0) return "00:00";
        var ts = TimeSpan.FromMilliseconds(ms.Value);
        return $"{(int)ts.TotalMinutes:00}:{ts.Seconds:00}";
    }
}